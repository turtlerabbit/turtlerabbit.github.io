---
title: FULL STACK WFP 07 - Fetching Stock Prices and Refactoring API Calls
date: '2021-05-12 07'
tag: WPF, FullStack, Refactoring
---
#
Simbol에 대한 Stock Price를 가져 오는 Service Class를 만든다.   
StockPriceService와 MajorIndexService 사이의 중복을 발견 한 후 사용자 지정 HttpClient를 도입하여 두 클래스를 모두 리팩터링한다.   
또한 StockPriceService에 잘못된 기호가 전달 될 때 throw 할 custom exception을 만든다.  
switch 문에 대한 기본값으로 예외를 던지고 MajorIndexes에 대해 Name 추가한다.  
Stock 클래스의 이름을 Asset으로 변경하여 응용 프로그램 전체를 정리한다.
#
### 1. Fetching Stock Prices
* SimpleTrader.Domain / Services / IStockPriceService.cs
    ```js
    public interface IStockPriceService 
    {
        Task<double> GetPrice(string symbol);
    }
    ```
* SimpleTrader.FinancialModelingPrepAPI / Services / StockPriceService.cs
    ```js
    public class StockPriceService : IStockPriceService
    {
        public async Task<double> GetPrice(string symbol)
        {
            using (FinancialModelingPrepHttpClient client = 
                new FinancialModelingPrepHttpClient())
            {
                string apikey = "?apikey=de2b8964";
                string uri = "quote-short/" + symbol + apikey;

                HttpResponseMessage response = await GetAsync(uri);
                string jsonResponse = await response.Content.ReadAsStringAsync();

                StockPriceResult stockPriceResult = 
                    JsonConvert.DeserializeObject<StockPriceResult>(jsonResponse);

                return stockPriceResult.Price;
            }
        }
    }
    ```
* SimpleTrader.FinancialModelingPrepAPI / Results / StockPriceResult.cs
    ```js
    public class StockPriceResult
    {
        public double Price { get; set; }
    }
    ```
#
### 2. StockPriceService와 MajorIndexService 사이의 중복을 리팩터링한다.
* SimpleTrader.FinancialModelingPrepAPI / FinancialModelingPrepHttpClient.cs
    ```js
    public class FinancialModelingPrepHttpClient : HttpClient
    {
        public FinancialModelingPrepHttpClient()
        {
            this.BaseAddress = new Uri("https://financialmodelingprep.com/api/v3/");
        }

        public async Task<T> GetAsync<T>(string uri)
        {
            HttpResponseMessage response = await GetAsync(uri);
            string jsonResponse = await response.Content.ReadAsStringAsync();

            // '[',']' 문자 제거로 문제 해결
            jsonResponse = string.Join(string.Empty, jsonResponse.Split('[', ']'));

            return JsonConvert.DeserializeObject<T>(jsonResponse);
        }
    }
    ```
* SimpleTrader.FinancialModelingPrepAPI / Services / MajorIndexService.cs
    ```js
    public async Task<MajorIndex> GetMajorIndex(MajorIndexType indexType)
        {
            string apikey = "?apikey=de2b8964";
            string uri = "quote/" + GetUriSuffix(indexType) + apikey;

            using(FinancialModelingPrepHttpClient client = 
                new FinancialModelingPrepHttpClient())
            {
                MajorIndex majorIndex = await client.GetAsync<MajorIndex>(uri);
                majorIndex.Type = indexType;

                return majorIndex;
            }
        }
    ```
* SimpleTrader.FinancialModelingPrepAPI / Services / StockPriceService.cs
    ```js
    public async Task<double> GetPrice(string symbol)
        {
            using (FinancialModelingPrepHttpClient client = 
                new FinancialModelingPrepHttpClient())
            {
                string apikey = "?apikey=de2b8964";
                string uri = "quote-short/" + symbol + apikey;

                StockPriceResult stockPriceResult = 
                    await client.GetAsync<StockPriceResult>(uri);

                return stockPriceResult.Price;
            }
        }
    ```
#
### 3. StockPriceService에 잘못된 기호가 전달 될 때 throw 할 custom exception을 만든다.
* SimpleTrader.Domain / Exceptions / InvalidSymbolException.cs
    ```js
    public class InvalidSymbolException : Exception
    {
        public string Symbol { get; set; }

        public InvalidSymbolException(string symbol)
        {
            Symbol = symbol;
        }

        public InvalidSymbolException(string symbol, string message) : base(message)
        {
            Symbol = symbol;
        }

        public InvalidSymbolException(string symbol, 
            string message, Exception innerException) : base(message, innerException)
        {
            Symbol = symbol;
        }
    }
    ```
* SimpleTrader.FinancialModelingPrepAPI / Services / StockPriceService.cs
    ```js
    using (FinancialModelingPrepHttpClient client = new FinancialModelingPrepHttpClient())
    {
        ...

        if (stockPriceResult.Price == 0)
        {
            throw new InvalidSymbolException(symbol);
        }

        return stockPriceResult.Price;
    }
    ```
* SimpleTrader.FinancialModelingPrepAPI / Services / MajorIndexService.cs
    ```js
    private string GetUriSuffix(MajorIndexType indexType)
    {
        switch (indexType)
        {
            case MajorIndexType.DowJones:
                return "%5EDJI";
            case MajorIndexType.Nasdaq:
                return "%5EIXIC";
            case MajorIndexType.SP500:
                return "%5EGSPC";
            default:
                throw new Exception("MajorInexType does not have a suffix defined."); 
        }
    }
    ```
* SimpleTrader.Domain / Models / MajorIndex.cs
    ```js
    public class MajorIndex
    {
        public string Name { get; set; }  // 추가
        public double Price { get; set; }
        public double Change { get; set; }
        public MajorIndexType Type { get; set; }
    }
    ```
* SimpleTrader.WPF / Controls / MajorIndexCard.xaml
    ```js
    <TextBlock Grid.Row="0" FontSize="18" 
               HorizontalAlignment="Center"
               Text="{Binding Name, FallbackValue=Name}" />
    ```
#
### 4. Stock 클래스의 이름을 Asset으로 변경
* SimpleTrader.Domain / Models / Asset.cs
    ```js
    // Stock.cs -> Asset.cs 이름 변경

    public class Asset
    {
        // add-migration stock-to-asset 명령이 실패하는 경우는
        // 각 프로젝트 빌드가 실패했을 때 나타난다. 즉 각 프로젝트 빌드 시도!
        public string Symbol { get; set; }
        public double pricePerShare { get; set; }
    }
    ```
* SimpleTrader.Domain / Models / AssetTransaction.cs
    ```js
    public class AssetTransaction : DomainObject
    {
        public Account Account { get; set; }
        public bool IsPurchase { get; set; }
        public Asset Asset { get; set; }   // Stock -> Asset
        public int Shares { get; set; }
        public DateTime DateProcessed { get; set; }
    }
    ```
* Package Manager Console
    ```js
    PM> add-migration stock-to-asset  
    PM> update-database
    ```